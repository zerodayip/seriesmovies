name: Get Final Redirect HTML (Selenium)

on:
  workflow_dispatch:

jobs:
  scrape:
    runs-on: ubuntu-latest

    steps:
      - name: Kod deposunu çek
        uses: actions/checkout@v4

      - name: Node kurulumu
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Selenium ve ChromeDriver kurulumu
        run: |
          npm init -y
          npm install selenium-webdriver chromedriver

      - name: Selenium ile retry ve HTML al
        run: |
          node << 'EOF'
          const { Builder, By, until } = require('selenium-webdriver');
          const chrome = require('selenium-webdriver/chrome');

          (async () => {
            const TARGET_URL = "https://sezonlukdizi8.com/link.asp?id=";
            const MAX_RETRIES = 5;

            const options = new chrome.Options();
            options.addArguments('--headless=new');  // Headless mod
            options.addArguments('--disable-gpu');
            options.addArguments('--window-size=1920,1080');

            const driver = await new Builder()
              .forBrowser('chrome')
              .setChromeOptions(options)
              .build();

            let finalUrl = TARGET_URL;
            let html = "";
            let attempt = 0;

            try {
              while (attempt < MAX_RETRIES) {
                attempt++;
                console.log(`Deneme #${attempt} - Sayfaya gidiliyor: ${TARGET_URL}`);
                await driver.get(TARGET_URL);

                // Sayfanın yüklenmesini bekleyelim
                await driver.wait(async () => {
                  const readyState = await driver.executeScript('return document.readyState;');
                  return readyState === 'complete';
                }, 120000);

                html = await driver.getPageSource();
                finalUrl = await driver.getCurrentUrl();

                // Rate limit kontrolü
                const match = html.match(/Çok fazla istek yaptınız\. (\d+) saniye bekleyin/);
                if (match) {
                  const waitSeconds = parseInt(match[1], 10);
                  console.log(`Rate limit algılandı, ${waitSeconds} saniye bekleniyor...`);
                  await new Promise(resolve => setTimeout(resolve, waitSeconds * 1000));
                } else {
                  break; // Başarılı
                }
              }

              console.log("Son yönlendirme URL:", finalUrl);
              console.log("------- HTML BAŞLANGICI -------");
              console.log(html);
              console.log("------- HTML BİTİŞİ -------");

            } finally {
              await driver.quit();
            }
          })();
          EOF
