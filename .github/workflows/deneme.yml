name: Get Final OUO.io HTML (Selenium)

on:
  workflow_dispatch:

jobs:
  scrape:
    runs-on: ubuntu-latest

    steps:
      - name: Kod deposunu çek
        uses: actions/checkout@v4

      - name: Node kurulumu
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Selenium ve ChromeDriver kurulumu
        run: |
          npm init -y
          npm install selenium-webdriver chromedriver

      - name: Selenium ile OUO HTML al
        run: |
          node << 'EOF'
          const { Builder, By, until } = require('selenium-webdriver');
          const chrome = require('selenium-webdriver/chrome');

          (async () => {
            const TARGET_URL = "https://ouo.io/BEvZB5";
            const MAX_RETRIES = 3;

            const options = new chrome.Options();
            options.addArguments('--headless=new');
            options.addArguments('--disable-gpu');
            options.addArguments('--window-size=1920,1080');
            options.addArguments('--no-sandbox');
            options.addArguments('--disable-dev-shm-usage');
            options.addArguments('--disable-blink-features=AutomationControlled');
            options.excludeSwitches('enable-automation');
            options.addArguments('--user-agent=Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/143.0.0.0 Safari/537.36');

            const driver = await new Builder()
              .forBrowser('chrome')
              .setChromeOptions(options)
              .build();

            try {
              for (let attempt = 1; attempt <= MAX_RETRIES; attempt++) {
                console.log(`Deneme #${attempt} - Sayfaya gidiliyor: ${TARGET_URL}`);
                await driver.get(TARGET_URL);

                // WebDriver imzasını gizle
                await driver.executeScript(
                  "Object.defineProperty(navigator, 'webdriver', {get: () => undefined});"
                );

                // OUO JS challenge için bekle (10 saniye)
                await driver.sleep(10000);

                // Sayfanın tamamen yüklenmesini bekle
                await driver.wait(async () => {
                  const readyState = await driver.executeScript('return document.readyState;');
                  return readyState === 'complete';
                }, 15000);

                const html = await driver.getPageSource();
                const currentUrl = await driver.getCurrentUrl();

                // Basit rate limit kontrolü
                if (/Çok fazla istek yaptınız/.test(html)) {
                  console.log("Rate limit algılandı, 10 saniye bekleniyor...");
                  await new Promise(resolve => setTimeout(resolve, 10000));
                  continue;
                }

                console.log("Son URL:", currentUrl);
                console.log("------- HTML BAŞLANGICI -------");
                console.log(html);
                console.log("------- HTML BİTİŞİ -------");
                break;
              }
            } finally {
              await driver.quit();
            }
          })();
          EOF
