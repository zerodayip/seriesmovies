name: Get OUO.io Final HTML (Puppeteer)

on:
  workflow_dispatch:

jobs:
  scrape:
    runs-on: ubuntu-latest

    steps:
      - name: Kod deposunu çek
        uses: actions/checkout@v4

      - name: Node kurulumu
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Puppeteer kurulumu
        run: |
          npm init -y
          npm install puppeteer fs

      - name: OUO HTML al ve kaydet
        run: |
          node << 'EOF'
          const puppeteer = require('puppeteer');
          const fs = require('fs');

          (async () => {
            const TARGET_URL = "https://ouo.io/BEvZB5";
            const OUTPUT_FILE = "ouo_final_page.html";

            const browser = await puppeteer.launch({
              headless: "new",        // Headless modda çalışıyor, CI uyumlu
              args: [
                '--no-sandbox',
                '--disable-setuid-sandbox',
                '--disable-web-security',
              ]
            });

            const page = await browser.newPage();

            // OUO headers
            await page.setExtraHTTPHeaders({
              'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8',
              'Accept-Language': 'tr-TR,tr;q=0.9,en-GB;q=0.8,en;q=0.7,en-US;q=0.6',
              'Cache-Control': 'max-age=0'
            });

            await page.setUserAgent("Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/143.0.0.0 Safari/537.36");

            console.log("Sayfa açılıyor:", TARGET_URL);
            await page.goto(TARGET_URL, { waitUntil: 'networkidle2', timeout: 60000 });

            // Eğer OUO "Continue" butonu varsa tıkla
            try {
              const buttonSelector = 'a#btn-main'; // OUO continue button
              await page.waitForSelector(buttonSelector, { timeout: 15000 });
              await page.click(buttonSelector);
              console.log("Continue butonuna tıklandı...");
              await page.waitForNavigation({ waitUntil: 'networkidle2', timeout: 30000 });
            } catch (e) {
              console.log("Continue butonu bulunamadı veya atlandı.");
            }

            // Sayfa tamamen yüklendi
            const currentUrl = page.url();
            const html = await page.content();

            console.log("Son URL:", currentUrl);

            fs.writeFileSync(OUTPUT_FILE, html, { encoding: 'utf8' });
            console.log(`HTML '${OUTPUT_FILE}' olarak kaydedildi.`);

            await browser.close();
          })();
          EOF
