name: Get Final Redirect HTML (Headers + Retry)

on:
  workflow_dispatch:

jobs:
  scrape:
    runs-on: ubuntu-latest

    steps:
      - name: Kod deposunu çek
        uses: actions/checkout@v4

      - name: Node kurulumu
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Playwright kurulumu
        run: |
          npm init -y
          npm install playwright
          npx playwright install

      - name: Playwright ile retry ve custom headers
        run: |
          node << 'EOF'
          const { chromium } = require("playwright");

          (async () => {
            const TARGET_URL = "https://sezonlukdizi8.com/link.asp?id=";
            const MAX_RETRIES = 5;

            const browser = await chromium.launch({ headless: true });
            const page = await browser.newPage();

            // Özel headers
            await page.setExtraHTTPHeaders({
              'accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7',
              'accept-encoding': 'gzip, deflate, br, zstd',
              'accept-language': 'tr-TR,tr;q=0.9,en-GB;q=0.8,en;q=0.7,en-US;q=0.6',
              'cache-control': 'max-age=0',
              'sec-ch-ua': '"Google Chrome";v="143", "Chromium";v="143", "Not A(Brand";v="24"',
              'sec-ch-ua-platform': '"Windows"',
              'sec-ch-ua-platform-version': '"10.0.0"',
              'sec-ch-ua-mobile': '?0',
              'sec-fetch-dest': 'document',
              'sec-fetch-mode': 'navigate',
              'sec-fetch-site': 'none',
              'sec-fetch-user': '?1',
              'upgrade-insecure-requests': '1',
              'user-agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/143.0.0.0 Safari/537.36'
            });

            let finalUrl = TARGET_URL;
            let html = "";
            let attempt = 0;

            while (attempt < MAX_RETRIES) {
              attempt++;
              console.log(`Deneme #${attempt} - Sayfaya gidiliyor: ${TARGET_URL}`);

              await page.goto(TARGET_URL, { waitUntil: "networkidle", timeout: 120000 });

              html = await page.content();
              finalUrl = page.url();

              // Rate limit kontrolü
              const match = html.match(/Çok fazla istek yaptınız\. (\d+) saniye bekleyin/);
              if (match) {
                const waitSeconds = parseInt(match[1], 10);
                console.log(`Rate limit algılandı, ${waitSeconds} saniye bekleniyor...`);
                await new Promise(resolve => setTimeout(resolve, waitSeconds * 1000));
              } else {
                break;
              }
            }

            console.log("Son yönlendirme URL:", finalUrl);
            console.log("------- HTML BAŞLANGICI -------");
            console.log(html);
            console.log("------- HTML BİTİŞİ -------");

            await browser.close();
          })();
          EOF
