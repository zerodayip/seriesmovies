name: Get Final Redirect HTML (Playwright Retry)

on:
  workflow_dispatch:

jobs:
  scrape:
    runs-on: ubuntu-latest

    steps:
      - name: Kod deposunu çek
        uses: actions/checkout@v4

      - name: Node kurulumu
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Playwright kurulumu
        run: |
          npm init -y
          npm install playwright
          npx playwright install

      - name: Playwright ile retry ve HTML al
        run: |
          node << 'EOF'
          const { chromium } = require("playwright");

          (async () => {
            const TARGET_URL = "https://sezonlukdizi8.com/link.asp?id=";
            const MAX_RETRIES = 5;
            const WAIT_MS = 10000; // Bekleme süresi 10 saniye

            const browser = await chromium.launch({ headless: true });
            const page = await browser.newPage();

            let finalUrl = TARGET_URL;
            let html = "";
            let attempt = 0;

            while (attempt < MAX_RETRIES) {
              attempt++;
              console.log(`Deneme #${attempt} - Sayfaya gidiliyor: ${TARGET_URL}`);

              await page.goto(TARGET_URL, {
                waitUntil: "networkidle",
                timeout: 120000
              });

              html = await page.content();
              finalUrl = page.url();

              if (html.includes("Çok fazla istek yaptınız")) {
                console.log(`Rate limit algılandı. ${WAIT_MS/1000} saniye bekleniyor...`);
                await page.waitForTimeout(WAIT_MS);
              } else {
                break; // Başarılı
              }
            }

            console.log("Son yönlendirme URL:", finalUrl);
            console.log("------- HTML BAŞLANGICI -------");
            console.log(html);
            console.log("------- HTML BİTİŞİ -------");

            await browser.close();
          })();
          EOF
