name: Get Final Redirect HTML (Playwright Dynamic Wait)

on:
  workflow_dispatch:

jobs:
  scrape:
    runs-on: ubuntu-latest

    steps:
      - name: Kod deposunu çek
        uses: actions/checkout@v4

      - name: Node kurulumu
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Playwright kurulumu
        run: |
          npm init -y
          npm install playwright
          npx playwright install

      - name: Playwright ile retry ve HTML al (dinamik bekleme)
        run: |
          node << 'EOF'
          const { chromium } = require("playwright");

          (async () => {
            const TARGET_URL = "https://sezonlukdizi8.com/link.asp?id=";
            const MAX_RETRIES = 5;

            const browser = await chromium.launch({ headless: true });

            let finalUrl = TARGET_URL;
            let html = "";
            let attempt = 0;

            while (attempt < MAX_RETRIES) {
              attempt++;
              const page = await browser.newPage();
              console.log(`Deneme #${attempt} - Sayfaya gidiliyor: ${TARGET_URL}`);

              await page.goto(TARGET_URL, { waitUntil: "networkidle", timeout: 120000 });

              html = await page.content();
              finalUrl = page.url();

              // Rate limit kontrolü ve dinamik bekleme
              const match = html.match(/Çok fazla istek yaptınız\. (\d+) saniye bekleyin/);
              if (match) {
                const waitSeconds = parseInt(match[1], 10);
                console.log(`Rate limit algılandı, ${waitSeconds} saniye bekleniyor...`);
                await page.close();
                await new Promise(resolve => setTimeout(resolve, waitSeconds * 1000));
              } else {
                await page.close();
                break; // Başarılı, rate limit yok
              }
            }

            console.log("Son yönlendirme URL:", finalUrl);
            console.log("------- HTML BAŞLANGICI -------");
            console.log(html);
            console.log("------- HTML BİTİŞİ -------");

            await browser.close();
          })();
          EOF
